---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install Apache and PHP packages
  ansible.builtin.apt:
    name:
      - apache2
      - php
      - php-cli
      - php-fpm
      - php-pgsql
      - php-mbstring
      - php-xml
      - php-curl
      - php-zip
      - php-bcmath
      - php-json
      - php-tokenizer
      - libapache2-mod-php
      - git
      - unzip
    state: present

- name: Enable Apache rewrite module
  community.general.apache2_module:
    name: rewrite
    state: present
  notify: restart apache

- name: Install Composer
  ansible.builtin.shell: |
    curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  args:
    creates: /usr/local/bin/composer

- name: Clone Laravel application from GitHub
  ansible.builtin.git:
    repo: 'https://github.com/Practical-DevOps/app-for-devops.git'
    dest: /var/www/laravel-app
    version: main
    force: yes

- name: Set ownership of Laravel directory
  ansible.builtin.file:
    path: /var/www/laravel-app
    owner: www-data
    group: www-data
    recurse: yes

- name: Set permissions for storage and cache
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: www-data
    group: www-data
    mode: '0775'
    recurse: yes
  loop:
    - /var/www/laravel-app/storage
    - /var/www/laravel-app/bootstrap/cache

- name: Ensure session directory exists and is writable
  ansible.builtin.file:
    path: /var/www/laravel-app/storage/framework/sessions
    state: directory
    owner: www-data
    group: www-data
    mode: '0775'

- name: Ensure views directory exists and is writable
  ansible.builtin.file:
    path: /var/www/laravel-app/storage/framework/views
    state: directory
    owner: www-data
    group: www-data
    mode: '0775'

- name: Ensure cache directory exists and is writable
  ansible.builtin.file:
    path: /var/www/laravel-app/storage/framework/cache
    state: directory
    owner: www-data
    group: www-data
    mode: '0775'

- name: Install Composer dependencies
  become: yes
  become_user: www-data
  community.general.composer:
    command: install
    working_dir: /var/www/laravel-app
    no_dev: no

- name: Create .env file from template
  ansible.builtin.template:
    src: env.j2
    dest: /var/www/laravel-app/.env
    owner: www-data
    group: www-data
    mode: '0644'

- name: Check if APP_KEY is set in .env
  ansible.builtin.shell: grep -q "^APP_KEY=base64:" /var/www/laravel-app/.env
  register: app_key_check
  failed_when: false
  changed_when: false

- name: Generate Laravel application key
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan key:generate --force
  args:
    chdir: /var/www/laravel-app
  when: app_key_check.rc != 0

- name: Clear Laravel configuration cache
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan config:clear
  args:
    chdir: /var/www/laravel-app

- name: Clear Laravel cache
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan cache:clear
  args:
    chdir: /var/www/laravel-app

- name: Test database connection
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan db:show
  args:
    chdir: /var/www/laravel-app
  register: db_test
  failed_when: false

- name: Run Laravel migrations
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan migrate --force
  args:
    chdir: /var/www/laravel-app
  register: migration_result

- name: Display migration output
  ansible.builtin.debug:
    var: migration_result

- name: Verify migrations table exists
  become: yes
  become_user: www-data
  ansible.builtin.shell: php artisan migrate:status
  args:
    chdir: /var/www/laravel-app
  register: migrate_status

- name: Display migration status
  ansible.builtin.debug:
    var: migrate_status.stdout_lines

- name: Clear all Laravel caches after migration
  become: yes
  become_user: www-data
  ansible.builtin.shell: |
    php artisan config:clear
    php artisan cache:clear
    php artisan route:clear
    php artisan view:clear
  args:
    chdir: /var/www/laravel-app

- name: Cache Laravel configuration and routes for better performance
  become: yes
  become_user: www-data
  ansible.builtin.shell: |
    php artisan config:cache
    php artisan route:cache
  args:
    chdir: /var/www/laravel-app

- name: Configure Apache virtual host
  ansible.builtin.template:
    src: laravel-vhost.conf.j2
    dest: /etc/apache2/sites-available/laravel.conf
    mode: '0644'
  notify: restart apache

- name: Disable default Apache site
  ansible.builtin.command: a2dissite 000-default.conf
  args:
    removes: /etc/apache2/sites-enabled/000-default.conf
  notify: restart apache

- name: Enable Laravel site
  ansible.builtin.command: a2ensite laravel.conf
  args:
    creates: /etc/apache2/sites-enabled/laravel.conf
  notify: restart apache

- name: Ensure Apache is started and enabled
  ansible.builtin.service:
    name: apache2
    state: started
    enabled: yes

- name: Flush handlers to restart Apache
  ansible.builtin.meta: flush_handlers

- name: Wait for Apache to be fully ready
  ansible.builtin.wait_for:
    port: 80
    delay: 2
    timeout: 30

- name: Verify Laravel application is accessible
  ansible.builtin.uri:
    url: http://localhost
    status_code: 200
    timeout: 10
  register: app_check
  retries: 3
  delay: 2
  until: app_check.status == 200
